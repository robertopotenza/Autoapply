<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Countries Test Harness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        h2 {
            color: #374151;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: #10b981;
        }
        
        button.secondary:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .results {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .results .pass {
            color: #10b981;
            font-weight: bold;
        }
        
        .results .fail {
            color: #ef4444;
            font-weight: bold;
        }
        
        .results .info {
            color: #3b82f6;
        }
        
        .results .warning {
            color: #f59e0b;
        }
        
        /* Multi-select styles (copied from main app) */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        .multi-select-container {
            position: relative;
        }
        
        .multi-select-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .multi-select-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #f9fafb;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 13px;
            gap: 6px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .dropdown.hidden {
            display: none;
        }
        
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .dropdown-item:hover {
            background: #f3f4f6;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.pass {
            background: #10b981;
        }
        
        .status-indicator.fail {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Remote Countries Test Harness</h1>
        <p class="subtitle">Validate multi-select data flow and round-trip persistence</p>
        
        <!-- Test Multi-Select Component -->
        <div class="section">
            <h2>Test Multi-Select Component</h2>
            <div class="form-group">
                <label for="remote-countries-input">Select Remote Countries:</label>
                <div class="multi-select-container">
                    <input 
                        type="text" 
                        id="remote-countries-input" 
                        class="multi-select-input"
                        placeholder="Type to search countries..."
                    >
                    <div id="remote-countries-dropdown" class="dropdown hidden"></div>
                </div>
                <div id="remote-countries-tags" class="tags-container"></div>
                <input type="hidden" id="remote-countries" name="remote-countries">
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="section">
            <h2>Run Tests</h2>
            <div class="button-group">
                <button onclick="runFrontendConsistencyTest()">
                    üîç Run Frontend Consistency Test
                </button>
                <button onclick="runMockRoundTripTest()" class="secondary">
                    üîÑ Run Mock Round-Trip (Save ‚Üí Load)
                </button>
                <button onclick="clearResults()" style="background: #6b7280;">
                    üóëÔ∏è Clear Results
                </button>
            </div>
        </div>
        
        <!-- Results Panel -->
        <div class="section">
            <h2>Test Results</h2>
            <div id="results" class="results">
                <div class="info">Ready to run tests. Select some countries above and click a test button.</div>
            </div>
        </div>
    </div>

    <script>
        // Debug Mode Configuration
        const DEBUG_MODE = localStorage.getItem('DEBUG_MODE') === 'true' || window.AUTOAPPLY_DEBUG === true;

        // Debug logging helper
        function debugLog(...args) {
            if (DEBUG_MODE) {
                console.log(...args);
            }
        }

        // Mock formState (mimics the real app.js formState)
        const formState = {
            currentStep: 1,
            totalSteps: 4,
            data: {}
        };
        window.formState = formState;

        // Countries data (copied from app.js)
        const countries = [
            'United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'France',
            'India', 'China', 'Japan', 'Brazil', 'Mexico', 'Spain', 'Italy', 'Netherlands',
            'Sweden', 'Norway', 'Denmark', 'Finland', 'Switzerland', 'Austria', 'Belgium',
            'Ireland', 'New Zealand', 'Singapore', 'South Korea', 'Poland', 'Portugal'
        ];

        // Store multi-select instances
        const multiSelectInstances = {};

        // Initialize multi-select (copied from app.js)
        function initMultiSelect(baseId, options, maxItems = null) {
            const input = document.getElementById(`${baseId}-input`);
            const tagsContainer = document.getElementById(`${baseId}-tags`);
            const dropdown = document.getElementById(`${baseId}-dropdown`);
            const hiddenInput = document.getElementById(baseId);

            if (!input || !tagsContainer || !dropdown) return;

            const selectedItems = new Set();

            renderDropdown(options, '');

            input.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = options.filter(opt =>
                    opt.toLowerCase().includes(searchTerm) && !selectedItems.has(opt)
                );
                renderDropdown(filtered, searchTerm);
            });

            input.addEventListener('focus', () => {
                dropdown.classList.remove('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            function renderDropdown(items, searchTerm) {
                dropdown.innerHTML = '';

                if (items.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item" style="color: #9ca3af;">No results found</div>';
                    dropdown.classList.remove('hidden');
                    return;
                }

                items.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = item;
                    div.addEventListener('click', () => addItem(item));
                    dropdown.appendChild(div);
                });

                if (searchTerm) {
                    dropdown.classList.remove('hidden');
                }
            }

            function addItem(item) {
                if (maxItems && selectedItems.size >= maxItems) {
                    alert(`Maximum ${maxItems} items allowed`);
                    return;
                }

                selectedItems.add(item);
                renderTags();
                input.value = '';
                renderDropdown(options.filter(opt => !selectedItems.has(opt)), '');
                updateHiddenInput();
            }

            function removeItem(item) {
                selectedItems.delete(item);
                renderTags();
                renderDropdown(options.filter(opt => !selectedItems.has(opt)), '');
                updateHiddenInput();
            }

            function renderTags() {
                tagsContainer.innerHTML = '';
                selectedItems.forEach(item => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.innerHTML = `
                        <span>${item}</span>
                        <span class="tag-remove" data-item="${item}">√ó</span>
                    `;
                    tag.querySelector('.tag-remove').addEventListener('click', () => removeItem(item));
                    tagsContainer.appendChild(tag);
                });
            }

            function updateHiddenInput() {
                if (hiddenInput) {
                    hiddenInput.value = Array.from(selectedItems).join(',');
                    // Update formState for immediate data capture
                    if (window.formState && window.formState.data) {
                        window.formState.data[baseId] = hiddenInput.value;
                        
                        debugLog('üåç REMOTE COUNTRIES UPDATE:', {
                            selectedItems: Array.from(selectedItems),
                            hiddenInputValue: hiddenInput.value,
                            formStateValue: window.formState.data[baseId]
                        });
                    }
                }
                input.value = '';
            }

            // Store instance API for programmatic access
            multiSelectInstances[baseId] = {
                addItem,
                removeItem,
                clear: () => {
                    selectedItems.clear();
                    renderTags();
                    updateHiddenInput();
                },
                setItems: (items) => {
                    selectedItems.clear();
                    items.forEach(item => {
                        // Trim whitespace from item
                        const trimmedItem = typeof item === 'string' ? item.trim() : item;
                        
                        // Try exact match first
                        if (options.includes(trimmedItem)) {
                            selectedItems.add(trimmedItem);
                        } else {
                            // Try case-insensitive match
                            const matchedOption = options.find(opt => 
                                opt.toLowerCase() === trimmedItem.toLowerCase()
                            );
                            if (matchedOption) {
                                selectedItems.add(matchedOption);
                                console.log(`üìù Matched "${trimmedItem}" to "${matchedOption}"`);
                            } else {
                                console.warn(`‚ö†Ô∏è Could not match item "${trimmedItem}" in ${baseId} options`);
                            }
                        }
                    });
                    renderTags();
                    updateHiddenInput();
                },
                getItems: () => Array.from(selectedItems)
            };

            return multiSelectInstances[baseId];
        }

        // Parse comma-separated values (copied from app.js)
        function parseCommaSeparated(value) {
            if (!value || value.trim() === '') return [];
            return value.split(',').map(item => item.trim()).filter(item => item);
        }

        // Initialize the multi-select on page load
        initMultiSelect('remote-countries', countries);

        // Test 1: Frontend Consistency Test
        function runFrontendConsistencyTest() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info"><strong>Running Frontend Consistency Test...</strong></div><br>';
            
            let allPassed = true;
            const testResults = [];
            
            // Get current selected countries
            const instance = multiSelectInstances['remote-countries'];
            const selectedCountries = instance.getItems();
            
            testResults.push(`<div class="info">üìä Selected Countries: ${selectedCountries.join(', ')}</div>`);
            testResults.push(`<div class="info">üìä Count: ${selectedCountries.length}</div><br>`);
            
            if (selectedCountries.length === 0) {
                results.innerHTML += '<div class="warning">‚ö†Ô∏è No countries selected. Please select some countries first.</div>';
                return;
            }
            
            // Test 1: Check hidden input value
            const hiddenInput = document.getElementById('remote-countries');
            const hiddenValue = hiddenInput.value;
            const hiddenArray = parseCommaSeparated(hiddenValue);
            
            testResults.push('<div class="info"><strong>Test 1: Hidden Input Value</strong></div>');
            testResults.push(`<div>Hidden Input Value: "${hiddenValue}"</div>`);
            testResults.push(`<div>Parsed Array: [${hiddenArray.join(', ')}]</div>`);
            
            const hiddenMatches = JSON.stringify(hiddenArray.sort()) === JSON.stringify(selectedCountries.sort());
            if (hiddenMatches) {
                testResults.push(`<div class="pass">‚úÖ PASS: Hidden input matches selected items</div><br>`);
            } else {
                testResults.push(`<div class="fail">‚ùå FAIL: Hidden input does not match selected items</div>`);
                testResults.push(`<div class="fail">Expected: [${selectedCountries.join(', ')}]</div>`);
                testResults.push(`<div class="fail">Got: [${hiddenArray.join(', ')}]</div><br>`);
                allPassed = false;
            }
            
            // Test 2: Check formState.data
            const formStateValue = window.formState.data['remote-countries'];
            const formStateArray = parseCommaSeparated(formStateValue);
            
            testResults.push('<div class="info"><strong>Test 2: FormState.data Value</strong></div>');
            testResults.push(`<div>FormState Value: "${formStateValue}"</div>`);
            testResults.push(`<div>Parsed Array: [${formStateArray.join(', ')}]</div>`);
            
            const formStateMatches = JSON.stringify(formStateArray.sort()) === JSON.stringify(selectedCountries.sort());
            if (formStateMatches) {
                testResults.push(`<div class="pass">‚úÖ PASS: FormState matches selected items</div><br>`);
            } else {
                testResults.push(`<div class="fail">‚ùå FAIL: FormState does not match selected items</div>`);
                testResults.push(`<div class="fail">Expected: [${selectedCountries.join(', ')}]</div>`);
                testResults.push(`<div class="fail">Got: [${formStateArray.join(', ')}]</div><br>`);
                allPassed = false;
            }
            
            // Test 3: parseFormData compatibility
            const parsedData = parseCommaSeparated(window.formState.data['remote-countries']);
            
            testResults.push('<div class="info"><strong>Test 3: ParseFormData Compatibility</strong></div>');
            testResults.push(`<div>Parsed Data: [${parsedData.join(', ')}]</div>`);
            
            const parseMatches = JSON.stringify(parsedData.sort()) === JSON.stringify(selectedCountries.sort());
            if (parseMatches) {
                testResults.push(`<div class="pass">‚úÖ PASS: ParseFormData produces correct array</div><br>`);
            } else {
                testResults.push(`<div class="fail">‚ùå FAIL: ParseFormData produces incorrect array</div>`);
                testResults.push(`<div class="fail">Expected: [${selectedCountries.join(', ')}]</div>`);
                testResults.push(`<div class="fail">Got: [${parsedData.join(', ')}]</div><br>`);
                allPassed = false;
            }
            
            // Final result
            if (allPassed) {
                testResults.push('<div class="pass" style="font-size: 16px; margin-top: 10px;"><span class="status-indicator pass"></span>ALL TESTS PASSED ‚úÖ</div>');
            } else {
                testResults.push('<div class="fail" style="font-size: 16px; margin-top: 10px;"><span class="status-indicator fail"></span>SOME TESTS FAILED ‚ùå</div>');
            }
            
            results.innerHTML = testResults.join('\n');
        }

        // Test 2: Mock Round-Trip Test
        function runMockRoundTripTest() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info"><strong>Running Mock Round-Trip Test...</strong></div><br>';
            
            let allPassed = true;
            const testResults = [];
            
            // Get current selected countries
            const instance = multiSelectInstances['remote-countries'];
            const originalCountries = instance.getItems();
            
            if (originalCountries.length === 0) {
                results.innerHTML += '<div class="warning">‚ö†Ô∏è No countries selected. Please select some countries first.</div>';
                return;
            }
            
            testResults.push(`<div class="info">üìä Original Countries: [${originalCountries.join(', ')}]</div><br>`);
            
            // Test 1: Round-trip with Array format (frontend ‚Üí backend ‚Üí frontend)
            testResults.push('<div class="info"><strong>Test 1: Array Format Round-Trip</strong></div>');
            testResults.push(`<div>Simulating: Frontend ‚Üí Backend (Array) ‚Üí Frontend</div>`);
            
            // Simulate backend save (array format)
            const mockSavedArray = [...originalCountries];
            testResults.push(`<div>Mock DB stored as: [${mockSavedArray.join(', ')}]</div>`);
            
            // Simulate backend load (returns array)
            const mockLoadedArray = mockSavedArray;
            testResults.push(`<div>Mock DB returned as: [${mockLoadedArray.join(', ')}]</div>`);
            
            // Repopulate multi-select
            instance.clear();
            instance.setItems(mockLoadedArray);
            
            const repopulatedArray = instance.getItems();
            testResults.push(`<div>Repopulated items: [${repopulatedArray.join(', ')}]</div>`);
            
            const arrayMatches = JSON.stringify(repopulatedArray.sort()) === JSON.stringify(originalCountries.sort());
            if (arrayMatches) {
                testResults.push(`<div class="pass">‚úÖ PASS: Array format round-trip successful</div><br>`);
            } else {
                testResults.push(`<div class="fail">‚ùå FAIL: Array format round-trip failed</div>`);
                testResults.push(`<div class="fail">Expected: [${originalCountries.join(', ')}]</div>`);
                testResults.push(`<div class="fail">Got: [${repopulatedArray.join(', ')}]</div><br>`);
                allPassed = false;
            }
            
            // Test 2: Round-trip with JSON String format (some DBs might store as JSON string)
            testResults.push('<div class="info"><strong>Test 2: JSON String Format Round-Trip</strong></div>');
            testResults.push(`<div>Simulating: Frontend ‚Üí Backend (JSON String) ‚Üí Frontend</div>`);
            
            // Simulate backend save (JSON string format)
            const mockSavedJSON = JSON.stringify(originalCountries);
            testResults.push(`<div>Mock DB stored as: "${mockSavedJSON}"</div>`);
            
            // Simulate backend load (returns JSON string that needs parsing)
            const mockLoadedJSON = mockSavedJSON;
            const parsedJSON = JSON.parse(mockLoadedJSON);
            testResults.push(`<div>Mock DB returned as: "${mockLoadedJSON}"</div>`);
            testResults.push(`<div>Parsed JSON: [${parsedJSON.join(', ')}]</div>`);
            
            // Repopulate multi-select
            instance.clear();
            instance.setItems(parsedJSON);
            
            const repopulatedJSON = instance.getItems();
            testResults.push(`<div>Repopulated items: [${repopulatedJSON.join(', ')}]</div>`);
            
            const jsonMatches = JSON.stringify(repopulatedJSON.sort()) === JSON.stringify(originalCountries.sort());
            if (jsonMatches) {
                testResults.push(`<div class="pass">‚úÖ PASS: JSON string format round-trip successful</div><br>`);
            } else {
                testResults.push(`<div class="fail">‚ùå FAIL: JSON string format round-trip failed</div>`);
                testResults.push(`<div class="fail">Expected: [${originalCountries.join(', ')}]</div>`);
                testResults.push(`<div class="fail">Got: [${repopulatedJSON.join(', ')}]</div><br>`);
                allPassed = false;
            }
            
            // Test 3: Round-trip with comma-separated string format
            testResults.push('<div class="info"><strong>Test 3: Comma-Separated String Round-Trip</strong></div>');
            testResults.push(`<div>Simulating: Frontend ‚Üí Backend (CSV) ‚Üí Frontend</div>`);
            
            // Simulate backend save (comma-separated string)
            const mockSavedCSV = originalCountries.join(',');
            testResults.push(`<div>Mock DB stored as: "${mockSavedCSV}"</div>`);
            
            // Simulate backend load (returns comma-separated string)
            const mockLoadedCSV = mockSavedCSV;
            const parsedCSV = mockLoadedCSV.split(',').map(s => s.trim()).filter(s => s);
            testResults.push(`<div>Mock DB returned as: "${mockLoadedCSV}"</div>`);
            testResults.push(`<div>Parsed CSV: [${parsedCSV.join(', ')}]</div>`);
            
            // Repopulate multi-select
            instance.clear();
            instance.setItems(parsedCSV);
            
            const repopulatedCSV = instance.getItems();
            testResults.push(`<div>Repopulated items: [${repopulatedCSV.join(', ')}]</div>`);
            
            const csvMatches = JSON.stringify(repopulatedCSV.sort()) === JSON.stringify(originalCountries.sort());
            if (csvMatches) {
                testResults.push(`<div class="pass">‚úÖ PASS: CSV format round-trip successful</div><br>`);
            } else {
                testResults.push(`<div class="fail">‚ùå FAIL: CSV format round-trip failed</div>`);
                testResults.push(`<div class="fail">Expected: [${originalCountries.join(', ')}]</div>`);
                testResults.push(`<div class="fail">Got: [${repopulatedCSV.join(', ')}]</div><br>`);
                allPassed = false;
            }
            
            // Restore original selection
            instance.clear();
            instance.setItems(originalCountries);
            
            // Final result
            if (allPassed) {
                testResults.push('<div class="pass" style="font-size: 16px; margin-top: 10px;"><span class="status-indicator pass"></span>ALL ROUND-TRIP TESTS PASSED ‚úÖ</div>');
                testResults.push('<div class="info" style="margin-top: 10px;">‚ú® All data format round-trips work correctly. The multi-select component handles array, JSON string, and comma-separated formats properly.</div>');
            } else {
                testResults.push('<div class="fail" style="font-size: 16px; margin-top: 10px;"><span class="status-indicator fail"></span>SOME ROUND-TRIP TESTS FAILED ‚ùå</div>');
                testResults.push('<div class="warning" style="margin-top: 10px;">‚ö†Ô∏è Some data formats are not handled correctly. This may cause data loss during save/load cycles.</div>');
            }
            
            results.innerHTML = testResults.join('\n');
        }

        // Clear results
        function clearResults() {
            document.getElementById('results').innerHTML = '<div class="info">Ready to run tests. Select some countries above and click a test button.</div>';
        }
    </script>
</body>
</html>
